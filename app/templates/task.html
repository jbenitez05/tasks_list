{% extends "layout.html" %}

{% block title %}Tareas{% endblock %}

{% block content %}
<div class="columns">
    <div class="column"></div>
    <div class="column is-four-fifths">

        <div>
            <h1 class="title">Mis tareas</h1>
        </div>

        {% if create == True %}
        <div>
            <a href="/home"><button class="button" title="Volver a proyectos"><i class="fa fa-arrow-left" aria-hidden="true"></i></button></a>    
            <a href="/task/new/{{id}}"><button class="button" title="Nueva tarea"><i class="fa fa-plus" aria-hidden="true"></i></button></a>             
        </div>
        {% endif %}
        <div>

            <table class='table'>
                <thead>
                    <tr>
                        <th> <a href="{% if orderby == 'id' %}  ?orderby=~id {% elif orderby == '~id' %} ?orderby=id {% else %} ?orderby=id {% endif %}" class="table-link">ID {% if orderby == "id" %} <i class="fa fa-caret-up" aria-hidden="true"></i> {% elif orderby == "~id" %} <i class="fa fa-caret-down" aria-hidden="true"></i>{% endif %} </a> </th>
                        <th> <a href="{% if orderby == 'project' %}  ?orderby=~project {% elif orderby == '~project' %} ?orderby=project {% else %} ?orderby=project {% endif %}" class="table-link">Proyecto {% if orderby == "project" %} <i class="fa fa-caret-up" aria-hidden="true"></i> {% elif orderby == "~project" %} <i class="fa fa-caret-down" aria-hidden="true"></i>{% endif %} </a> </th>
                        <th> <a href="{% if orderby == 'name' %}  ?orderby=~name {% elif orderby == '~name' %} ?orderby=name {% else %} ?orderby=name {% endif %}" class="table-link">Nombre {% if orderby == "name" %} <i class="fa fa-caret-up" aria-hidden="true"></i> {% elif orderby == "~name" %} <i class="fa fa-caret-down" aria-hidden="true"></i>{% endif %}</a> </th>
                        <th> <a href="{% if orderby == 'description' %}  ?orderby=~description {% elif orderby == '~description' %} ?orderby=description {% else %} ?orderby=description {% endif %}" class="table-link">Descripción {% if orderby == "description" %} <i class="fa fa-caret-up" aria-hidden="true"></i> {% elif orderby == "~description" %} <i class="fa fa-caret-down" aria-hidden="true"></i>{% endif %}</a> </th>
                        <th> <a href="{% if orderby == 'finish_date' %}  ?orderby=~finish_date {% elif orderby == '~finish_date' %} ?orderby=finish_date {% else %} ?orderby=finish_date {% endif %}" class="table-link">Fecha estimada {% if orderby == "finish_date" %} <i class="fa fa-caret-up" aria-hidden="true"></i> {% elif orderby == "~finish_date" %} <i class="fa fa-caret-down" aria-hidden="true"></i>{% endif %}</a> </th>
                        <th> <a href="{% if orderby == 'is_complete' %}  ?orderby=~is_complete {% elif orderby == '~is_complete' %} ?orderby=is_complete {% else %} ?orderby=is_complete {% endif %}" class="table-link">¿Completado? {% if orderby == "is_complete" %} <i class="fa fa-caret-up" aria-hidden="true"></i> {% elif orderby == "~is_complete" %} <i class="fa fa-caret-down" aria-hidden="true"></i>{% endif %}</a> </th>
                        <th> <a href="{% if orderby == 'created_on' %}  ?orderby=~created_on {% elif orderby == '~created_on' %} ?orderby=created_on {% else %} ?orderby=created_on {% endif %}" class="table-link">Fecha de creación {% if orderby == "created_on" %} <i class="fa fa-caret-up" aria-hidden="true"></i> {% elif orderby == "~created_on" %} <i class="fa fa-caret-down" aria-hidden="true"></i>{% endif %}</a> </th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>

                

                    {% for row in rows %}
                    <tr id="row-{{ row['id'] }}">
                        <td>{{ row['id'] }}</td>
                        <td>{{ row['project'] }}</td>
                        <td>{{ row['name'] }}</td>
                        <td>{{ row['description'] }}</td>
                        <td><span class="{{ row['span'] }}">{{ row['finish_date'] }}</span></td>
                        <td>
                            <label class="checkbox">
                                <input
                                    type="checkbox"
                                    hx-post="/update_task"
                                    hx-trigger="change"
                                    hx-params="serialize"
                                    hx-target="#row-{{ row['id'] }}"
                                    hx-swap="outerHTML"
                                    name="is_complete"
                                    data-id="{{ row['id'] }}"
                                    {% if row['is_complete'] == True %} checked {% endif %}
                                />
                            </label>
                        </td>
                        <td>{{ row['created_on'].date() }}</td>

                        <td>
                            <a href="/task/edit/{{ row['id'] }}" title="Editar tarea"><button class="button"><i class="fa fa-pencil-square-o" aria-hidden="true"></i>
                            </button></a>
                            <button class="button" id="delete_{{ row['id'] }}" onclick="deleteRow('{{ row['id'] }}')" title="Eliminar tarea"><i class="fa fa-trash-o" aria-hidden="true"></i></button>
                        </td>
                    </tr>  
                    {% endfor %}
                </tbody>
            </table>


        </div>
    </div>
    <div class="column"></div>
</div>
    
{% endblock %}

{% block scripts %}

<script>
    document.addEventListener('htmx:configRequest', function (event) {
        const input = event.target;
        if (input.name === 'is_complete') {
            const isChecked = input.checked ? 'on' : 'off';
            const rowId = input.getAttribute('data-id');
            event.detail.parameters = {
                is_complete: isChecked,
                id: rowId
            };
        }
    });
</script>


    <script>
        function deleteRow(rowId) {
            Swal.fire({
                title: "¿Estás seguro?",
                text: "¡No podrás revertir esto!",
                icon: "warning",
                showCancelButton: true,
                confirmButtonColor: "#3085d6",
                cancelButtonColor: "#d33",
                confirmButtonText: "Sí, elimínalo!"
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch('/task/delete/' + rowId, {
                        method: 'DELETE',
                    })
                    .then(response => {
                        if (response.ok) {
                            Swal.fire({
                                title: "¡Eliminado!",
                                text: "El registro ha sido eliminado.",
                                icon: "success"
                            }).then(() => {
                                location.reload();
                            });
                        } else {
                            Swal.fire({
                                title: "Error",
                                text: "Hubo un problema al eliminar el registro.",
                                icon: "error"
                            });
                            console.error('Error al eliminar el registro:', response.statusText);
                        }
                    })
                    .catch(error => {
                        Swal.fire({
                            title: "Error",
                            text: "Hubo un problema al eliminar el registro.",
                            icon: "error"
                        });
                        console.error('Error al eliminar el registro:', error);
                    });
                }
            });
        }


    </script>
{% endblock %}